package internal

import (
	"fmt"
	"testing"

	"github.com/stretchr/testify/assert"
)

func ExampleVeryComplexFunction() {
	if 1 == 2 || 3 == 4 && 2 == 5 {
		for i := 1; i < 100; i++ {
			if 1 == 2 || 3 == 4 && 2 == 5 {
				for i := 1; i < 100; i++ {
					if 1 == 2 || 3 == 4 && 2 == 5 {
						for i := 1; i < 100; i++ {
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
							if 3 == 5 {
								fmt.Println()
							}
						}
					}
				}
			}
		}
	}
}

func ExampleVeryLongfunction() {
	var i int
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	{
		i++
		i++
		i++
		i++
		i++
		i++
		i++
		i++
	}
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	i++
	println(i)
}

func ExampleFuncWithNesting() {
	for i := 0; i < 5; i++ {
		{
			go func() {
				func() {
					fmt.Println(1)
				}()
			}()
		}
	}
}

func TestNesting(t *testing.T) {
	params := CmdParams{
		Types:        []FuncMeasurement{MaxNesting},
		IncludeTests: true,
	}
	stats := Do(params, []string{"."})
	assert.NotEmpty(t, stats)

	s, found := findResultForFunc("ExampleFuncWithNesting", stats)
	if !assert.True(t, found) {
		return
	}

	val, err := s.Get(MaxNesting)
	assert.Nil(t, err)
	assert.Equal(t, 5.0, val)

	val, err = s.Get(TotalNesting)
	assert.Nil(t, err)
	assert.Equal(t, 25.0, val)
}

func ExampleFuncWithComments() {
	println(1) // ...
	/*
		1
		2
		3
		4
		5
	*/
	println(2)
	var err error
	if err != nil {
		panic(err)
	}
}

func TestLines(t *testing.T) {
	params := CmdParams{
		Types:        []FuncMeasurement{MaxNesting},
		IncludeTests: true,
	}
	stats := Do(params, []string{"."})
	assert.NotEmpty(t, stats)

	s, found := findResultForFunc("ExampleFuncWithComments", stats)
	if !assert.True(t, found) {
		return
	}

	val, err := s.Get(Lines)
	assert.Nil(t, err)
	assert.Equal(t, 6.0, val)

	val, err = s.Get(TotalLines)
	assert.Nil(t, err)
	assert.Equal(t, 16.0, val)
}

func TestDividedBy(t *testing.T) {
	params := CmdParams{
		Types:        []FuncMeasurement{MaxNesting},
		IncludeTests: true,
	}
	s, found := findResultForFunc("ExampleFuncWithComments", Do(params, []string{"."}))
	if !assert.True(t, found) {
		return
	}

	val1, err := s.Get(Complexity)
	assert.Nil(t, err)

	val2, err := s.Get(Lines)
	assert.Nil(t, err)

	val3, err := s.Get(FuncMeasurement(fmt.Sprintf("%s/%s", Complexity, Lines)))
	assert.Nil(t, err)

	assert.Equal(t, val3, val1/val2)
}

func findResultForFunc(funcname string, stats []FunctionStats) (*FunctionStats, bool) {
	for _, s := range stats {
		if s.Name == funcname {
			return &s, true
		}
	}
	return nil, false
}
